#include<stdlib.h>
#include<stdio.h>
#include<unistd.h>
#include<string.h>
#include<pthread.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <errno.h>

int main_thread_sweet_send_fd = -1;
int main_thread_sweet_recv_fd = -1;
int main_thread_selfie_send_fd = -1;
int main_thread_selfie_recv_fd = -1;

int main_started_listening_to_sweet = 0;
int main_started_listening_to_selfie = 0;

int sweet_started_listening_to_main = 0;
int selfie_started_listening_to_main = 0;

//actually it doesn't make any sense for these to be globals

int sweet_thread_send_fd = -1;
int sweet_thread_recv_fd = -1;
int selfie_thread_send_fd = -1;
int selfie_thread_recv_fd = -1;

int is_social_media_team_awake = 0;
int is_bakery_open = 0;

typedef struct sweet_s sweet_t;
typedef struct selfie_s selfie_t;

struct sweet_s {
	unsigned allocated;
	unsigned size;
	unsigned used_size; /* only non-ascii uses it */
	unsigned type; /*traditional / hipster */
	char *recipe;
};

struct selfie_s {
	unsigned allocated;
	unsigned size;
	unsigned used_size; /* for old-school (ascii) type, this is an unused field */
	unsigned type; /*old-school / modern */
	char *image;
};

selfie_t selfies[32];
sweet_t sweets[32];

char selfie_image_buffer[0x2000];
char sweet_image_buffer[0x2000];

char PNG_HDR[64] = "\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d\x49\x48\x44\x52\x00\x00\x00\xd1\x00\x00\x00\x2e\x08\x06\x00\x00\x00\xb6\xfe\xfc\x23\x00\x00\x00\x01\x73\x52\x47\x42\x00\xae\xce\x1c\xe9\x00\x00\x0f\xda\x49\x44\x41\x54\x78\x01\xed\x5b\x07\x90\x56\x35\x10\xff";

unsigned int PNG_HDR_size = 64;

//ascii art generated with https://manytools.org/hacker-tools/convert-images-to-ascii-art/go

char *banner_ascii = "................,................................................................................................,...................,....,........,.,.,.....,.\n\
..............................,.................,.....,.............................................................,.....,..........................,,..,.,,,.\n\
......................,................................,,................................,,......................................................,...,....,,.,,\n\
...........,..........,.......,.......................  ..........................................     ..      ............,................,,,...,...,,..,,,..\n\
.............,.......................................    ......................................                          ...........,.,........,,.....,,.,,,,..\n\
.........................,.....,..........    .......    ...............,....................       ....                ......,........,....,...,,,..,..,.,,,,.\n\
.......,.................,..............,.    .......    ....          ..... .....    ......      ......     ....................,......,..,,,.,.,.,,.,,,.,,,,,\n\
................,..............,.   ......     ......    ...             ..    ...    .....        .....    ............,....  ..  .......,,.....,...,.,,,,.,,,\n\
.................................. ,. ,....    ......    ...     ....     .    ..     .....        .....    ..............,..,,,,,,..,...,....,,,.,,.,.,.,,,,,,\n\
....................,.........   .,..,.....              ...     .....    .     .    .......         ..              ....., ,,   .,, ,,.,,...,.,.,..,.,.,.,,,.,\n\
........................... .,,,,,, , ......             ...             ...         ...........      .               .,.,, , ,,, ,, ,,.,,..,,,.,.,,,..,,,,,,,,\n\
........................., ,,,...  ,,, ,....     ....     ....          .....       ..   ....         .    ..............., , ,. ,. ,,,,,,..,.,.,,,,,...,,,,,,,\n\
...,..........,........,.,.. .,,,,,,. .,.....    .....    ....................     ..               ..    ...............,,,,. , .,,,,,..,..,,.,,,.,,,,,,,,,,,,\n\
.........................,..,,,,... ., ,.....     ....     .........,,.................          .....    ..............,,. ., ,,,,.,..,....,,..,,,,,,..,,,,.,,\n\
,........................,..    .,,,,...,.....     ....    .......,,.....,,,......,,....,,....,......           ........, .,,, ,.,.,,.,,,,.,.,,,,,,,,,,,,,,,..,\n\
......................,..,.,,,,,,,... .,,......   .........,.,................,.........................          ......,.,,,,,,  .,,,,.,,,,,..,,,,,,,,,,,,,,,,\n\
..........................              ,...,........,................... . ... ., . ... .,,.................    ....,.,, ,,,..,,,,. .,.,..,,.,,,,,,.,,,,,,,,,,\n\
..................,. ....,, ,,,,,,,,,..,,........,........................   , .   .      .,.....,.....................,,. ,,..,.,.,,, ,,.,.. ,,,,.,,,,,,,,,,,,\n\
................,.  ,,,...,..,......, ,.......,,....................... ..  ,, .  .,..,.  ,,..,...,...,.....,.......,.,..,,  .,.,,,..,, ,,,,,  .,,,,,,,.,,,,,,,\n\
.....,.........,  .,,......, ,....., .,....       ..,.......,.........,...,.,..   ,,      ,,..,.   .,  ,.....,..,.......,.,,,,. .  ,,. , ,,,,,,  ,,,,,,,,,,,,,,\n\
..............,  ,,........,. ,...,. ,.,.   ,,,,,    ,................,,              .,,,,..,.  ,,   ,,..,....,....,,.......,,.. ... ,  ,,,,,,,  ,,,,,,,,,,,,,\n\
............,,  ,,...,.....,, ...., ,,,.  ,,,,..,,,  .........,........,,,,.  ..,,,,  .,        ..  ,,,...,.,.        ,,.,..,,,. ,, ,,,,,,,,.,,,,  .,,,,,,,,,,,\n\
.,..........,  ,,.,.........,, ,., .,.,  .,.......,  .,....................,,,,,....,,.,,,,  ,,   ,,,.,.,..,.   ,,,,   ,,,,.,.,. ,, ,,,,,,,,,,,,,,  ,,,,,,,,,,,\n\
...........,  ,,.............,. . .,,.,.  ,....,..   ,   ,..,  ,..,  ...................,   ,   ,,,..,,....,.  ,,,,,   .,,,.,.,. ,, ,,,,,,,,,,,,,,,  ,,,,,,,,,,\n\
..........,. .,,.............,,,,,,....,.  ,       ,,,,  ,,,  .,,,  .,     .,.,.    ..,,  .  .,,,,,  ,,..,,,,   .,,,   ,,,..,,,. , ,,,,,,,,,,,,.,,,, .,,,,,,,,,\n\
,.........,  ,,.........................,,  .,,,,,,,.,  ,,,  ,,,.  ,   ,,  ,,.  ,,  ,,,  ,,,,,,,     ,..,...,,    .,,,,,,,.,,,,,,,,,,,,,,,,,,,,,,,,,  ,,,,,,,,,\n\
.........., .,...............,..,.......,,,,  ,.....,  ,,,  ,,,   ,  .,   ,,.  ,.  ,,,  ,,....   ,,. .,.,.,..,,,    ,,,,,,,,,,,,,,,,.,,,,,,,,,,,,,,,  ,,,,,,,,,\n\
.........,, .,..........,,....,.. ..,......,,  .,.... .,,.  ,.  .,  .   ,. ,     ., .  ,,,,.   ,,,,,  ,,..,.  ,,,.   .,,,,,,,,,,,,,,   .,,,,.  ,,,,,. .,,,,,,,,\n\
...,....,,, .,..............,.   ..    .,...,,  .,.,  .    .  .,,,  .,.   ,, .,.   ,,  ,    ,,,  ,,.  ,,.,.   ,,,,    .,.,.  ,,,,,,,,  .      ,,,,,,. .,,,,,,,,\n\
,........,, .,..............,  .,,,,,,.   .,.,.  ,.,,  ,,,. ,,,...,,   ,,,,,,   .,,,,,  .,,,,,,,.   ,,,,,,   .,,    ,,,,,    ,,,,,,,,,  ,,, .,,,,,,,. ,,,,,,,,,\n\
..........,  ,..............,.  ,....,,,,,.  ,   ,...........,.,...,,,,..............,,,,......,,,,,,,,,,,    ,,,,,,,,.    ,,,,,,,,,. ..  ,  ,,,,,,,  ,,,,,,,,,\n\
..........,. .,.............,,   ,.......,,,.   ,,       .,.         ,.              ,.     .,,.     ,.,,,,    .,,,,.       ,,,,,,,    .,.    ,,,,,, .,,,,,,,,,\n\
...........,  ,,........,.....,,    .....     ,,,,,,,,,,,.  .,,,,,,.  .,,,,,,,,,,,,,,   ,.  ,.   ,.  ,,,,,,,,          ,,.    ,,,,,,,,,,,,,,  .,,,,  ,,,,,,,,,,\n\
...........,,  ,...............,,,,,.....,,,,,,..,.....,,  ,,......,.  ,.,...,.....   ,,  ,,  .,,  .,,,,,..,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,  ,,,,,,,,,,,\n\
............,,  ,.....,............,,,,,,,,............,,  ,.......,   ,..........  ,,   ,,  ,,.   ,. .,..,,,,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,  .,,,,,,,,,,,\n\
............,,,  ,......,..............,.,.     .,....,.,   ,  ...    ,,....,..,.  ,.  ,,.  ,,   ,,   ,,,...,,,,,,,,,,,,,,,.,,,,,,,,,,,,,,,,,,,,  .,,,,,,,,,,,,\n\
...,...,......,,  .,...............,.,,  ,   .   .  ....,,.  ,,....,,,.  .. .,,  .   ,,,   ,   ,,,  ,,.  .. .,,,,,  ,,,,.  .,,   ,,,,,,,,,,,,,,  ,,,,,,,,,,,,,,\n\
...............,,.  ,................, . ,  ...  , . .,..,,,  .,,,,,,  ,,.  ,,  .  .,,,.  .  ,,,.  ,,   ,.  ,,.   . ,,,,,  ,,. .,,,,,,,,,,,,,  .,,,,,,,,,,,,,,,\n\
..........,.....,,,   ,............., . . . ,.,. . .. .,...,,.  ,.,,  ,.  .,,  .,.,,,,.    .,  ,  ,,  .,   ,,   ,,, .,,,,  ,, .,,,,,,,,,,,,.  ,,,,,,,,,,,,,,,,,\n\
..............,....,,.  ,...........,  . .     ,  .. , ,.....,,  .,  ,..,.  .  ,,,  ..  ,,,  ,,  ,,. .,.,,   .,,,,,  ,,.  .,,  .,,,,,,,,,   ,,,,,,,,,,,,,,,,,,,\n\
....................,,,   ....,....,, , .  .   .  ., , . .....,,  ,.      .,,      ,.  ,,,,,,,.   .,  .    ,,,  ,,. .,,,,,,,,,,.,,,,,,,   ,,,,,,,,,,,,,,,,,,,,,\n\
..................,....,,,   .......,, , ,  .... . .. ,,,.   .,,  ,,,,,,,,,,,,,,,,,.  ,,,,,,,,,,..,,,,,,,,,,,,,,...,,,,,,,,,,,,,,,,,   ,,,,,,,,,,,,,,,,,,,,,,,,\n\
.........................,,,.   .....,,.. .  ..  . , ,,,,,,,. .   ,              ..  ,                          .,,,,,,,,,,,,,,,,.  .,,,,,,,,,,,,,,,,,,,,,,,,,,\n\
...........................,,,,.   ...,, ,.     .,.,,,,....,,.   ,,,,,,,,,,,,,,,,,  .,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,\n\
...............................,,,,,.,. ,,,,,,,,,,.           .,,,..,,,.,,,,,,,,,,,,,,,,,,,,,,..,,,,.,,,,,,,,,,,,,,,,,,,,.    ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,\n\
....,...............................,..,,........,,,,,,,,,,,,,,,..,.,,.,.,,,,,,.,,,,..,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,, ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,\n\
............,................,.....,  ,,,.,. ,.,..,,..,,.,,,,.,...,,..,,..,,..,,,,,.,,,,.,,,.,,,,.,,,,,,,,,,,,,,,,,,  ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,\n\
.......,...........................,,,.....,,,,,,,,.. .,.,,....,....,,.,,.,.,,,,,,.,,.,,,,,,,,,,,,,,,,,,,,  .,,,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,\n\
..................,.............................,..,,,,,,. .,,  .,...,,,,.,,,.,..,,,,,,,,,,,.,,,. .,,. .,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,\n\
...........,..................,.......,..........,..,.,..,,,,,,,,,,,.,,,  ,,,  ,,,  ,,,  ,,,..,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,\n\
.,............,...........,.,...........................,...,...,,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,\n";

char *selfie_ascii = "%%#(+,.,//+..,++,..................,+/(///(#%%#/+,,,++//(((####((((//++++++++/////+,,,.,,+++++++,,,,,,....,,,++++++,.,,+++,,.,,++///((((##(((////++,,,,,,+,,,,+\n\
%%#(+..+//,..,++,..................,+/////(##((///((#####(((//+++++++++///++++/+++,,..,,+,,,,,,,+++,,....,,,,,,,,+++++++++//((((((((///++++++,,,,,,,,,,,+++++,,\n\
%##/,.,+//,..+++...................,+/////((((####(((///+++++++///////+.....,,,,,++++++,......,,+++++++,,,,,....,+//((((###((//+++,,,,,,,,,,,,,,,++,,++,,,,,,,,\n\
%#(/,.,//+,.,++,................,,+/((###(((((///++++++/////++,,,,,++++,,,,,,,....,++++,,....,+,...,++++++++//(((((((//++,,,,,,,,,,,,,,,,,,,++,,,,,+,,,,,+++++,\n\
%#(+..,//+,.,++,........,,,,,++//((((((///+++++/////++++++++,,..,,,,.,,,+++,.....,,,++,+,,,,,,,.,,,++/(((((((//++,,,,,,...,,,,,,,,,,,,,,,,,,,,,,,+,,,,+++++++,,\n\
%#/,..+//,..,++,..,,,,++//(((((////+++++/////++//++,..,,+,,++++++,,....,,+,,,,..,,,,...,,++++///((((///+++,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,++,,,,,,,,+,+++\n\
#(/,.,+/+,,+///++//((((((///++++++///////+,..,,++++,,,,,,....,++/+++++++,,.,+++,,,+++////((///+++,,..,,,,..,,,...,,,,,,,,,,,,,,,,,,,,,+,,,,,,,,,,,,,,,,,,,+++++\n\
#(+,,+/(((####((((///+++++//////+,,,,,++++,,,,,...,,,,,,..,,++//////((((((((((((/////++++,,,,..........,,,..,,,...,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,+,++,,,,\n\
(((#####(((///+++++/////++,,,++++,,,,,...,+++,...,,,++///++///(((((((####(((#####((/+,....,,..,,,....,.....,,.....,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,+,,,,,,,,+,\n\
(((////+++//////+++,++++,,,,,,,,++++,....,,+++,,,,+,,,+((((((##(((((########(########((/++,,,,,,,,,,........,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,+,,,,,+,,,,,,,\n\
/////////++++/++,,,,,,,,,++,,..,,++++,,,,,...,,+++++///((((((((((########%%%%############(((/+,,,,,,,,,.....,..,,,,,,,,,,,,,,,,,,.,,,,,,,,,,,,,,,,,,,,,,,,,,,++\n\
/++++++++,,++,,++++,....,,++,..,,,,,++++++++////(((((((((###((################%%%%###%########(//++,,,,,,........,,,,,,,,,,,,,,,,,,,,,+,,,,,,,++,,,,,,,+,,,,+++\n\
++,,+,,,+++,,..,+++,,,,,,.,,,+++++++////((/////(####((####################%%%%%%%%%%%%%%%%%%%%####((/+,,,...,.....,,,,,,,,,,+++++++++++++++++++/+++,,++++++,,,,\n\
,+++,..,++++,,,,,,,++++,,++/////////++,,,,,+//((################(#####%%%%%%%%%%%%%%%%%%%%%%%%%%%%####(+,,...,...,,,,,,++++++++++++++++++++++++++++++++++++//+/\n\
,+++,,,,,,,++++++++/(((////++,,,,........,+((((##%%%%############%%&&&&&@&&&&%%%%%%&&&%%&&&&&&%%&&%%%%##(/+,,,,,,+++++,,++++++++++++++++++++++++++++++++++++++/\n\
+,,,+++++/////////+++,,,................,,/(((((#######%%%%######%%%&&&&@@@@@@@&&&&&&&&&&&&&&&&&&&&&%%%%%##(/+++++++++,,,++++++++++++++++++++++++++++++++++++++\n\
///(((////+++,,,.....,........,.........,+/((((####%%%####((###%%&&&&@@@@@@@@@&&&&&&&&&&&&&&&&&&&&&&&&%%%%%%(/+,,,,++,,,,,,+++++++++++///////++++++++++++++++++\n\
//++,,,,,,,,,,,,,,,,,,..................+/#################%%%%&&@&&&&&&&&&&&&&&&&&&&&&&&&&&&&&@@@&&&&&&&&&&%(/+++,,,++++/(((######################((((////++//\n\
,,,,,,,,,,,,,,,,,,,,,,..............,,,,+(#############%%%%%%&@@&&&&&%%%%%%%%%%%%%%%%%%%%%###%%%&&@@@&&&&&&&%%#/++//(#####((((///////////////////(((((#####(((/\n\
,,,,,,,,,,,,,,,,,,,....................,+((#######%%%%%%%%%%&&&&%%%%%#####(((((((((((((((///////(#%&@@@&&&&&&&%%####(///++++//////////////////++/////////((####\n\
,,,,,,,,,,,,,,,,,,.........,..........,,+/(##%%%%%%%%%%%#%%%%%####(((((//////////////+++++++++++++/#%&@@@@@@&&&%#(//++//((##%%%%%&&&&&&&&&&&%%%%##(((/////////(\n\
,,,,,,,,,,,,,,,......................,,,/(##%%%%%%%%#######(((((//////+++++++++++++++++,,,,,,,,,++++/#%&&@@@@&&&%#(##%%&&&&&&%%&&&&&&&&&%%%%%&&&&&&&&%%##(/////\n\
,,,,,,,,,,,,,,,...........,........,,++/(##%%%%%###(//(((//////+++++++++++++++++++,,,,,,,,,,,,,,,,++++/#&&&&&&&&&%%%%%%%%%%%%%%&&&&&&&&%&&&&%%&&&&&&&&&(////(\n\
,,,,,,,,,,,,,,...,,.............,,++++/(#%%%%%###(+++/////++++++,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,++/#%&&&&&&&%%%%&&&&&&&%%&&&&&%%%##%%%%%%&&&&&&&&&%#(////(\n\
+,,,,,,,,,.,,,,,,,,,,,,......,,,,+++++(######((//++++++++++,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,++/(%&&%%%&%%%%%%%##((((#####((##((((((#####%%%%%##(/////\n\
++++++++++,,,,,,,,,,.......,,+++,,+++/(##((#(+,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,+++/(%&%%%%%%###((((((//((((((#####(//////////(####(/////\n\
++++++++++++++,,,,,,,,....,,++,,,+/(((#####(+,..,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,+++/#%%%%%%%#####(//+++(##((########((////+++/(###(/////\n\
/+++++++++++++,,....,,.....,,,,+((((/(#####/+...................,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,++++(#%%%%%%%####(/+++/(((((((######(((((////(####(/////\n\
(((((//++++++,,.............,+(#(/+//(#####/,.....................,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,++++/#%%%%%%%###((/+,,+/////((#####(//++++////(###(/////\n\
//////////++,,,,,,,,,..,,,..,+//+/(%%%##%%#/,...................,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,+++++/#%%%%%%##((((/++,,++//(((#####(/+////++//(###(/////\n\
&%%%%#((//+,,,,,,,,,,,,,,,..,+/++(%&&%#%%%%/,..................,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,+++++/(%&&%%%#(((((/+++,+//(/((####((/+++++//+/((##(/////\n\
&&&&%%%%#(+,,,,,,,,,,,,,,,..,+/+/(#%%##%%%%(,,,,.............,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,+++++/(%&&%%##((###/+++//////((####(((//(((((##%%###(////\n\
%%#((###(/,,...,,,,,,,,,,..,++///(#%%##%%%#(+,,,........,,,,,,,,,,,,,,,,,,,,,,,,++++++++,,,,,,,,,,,,,,+++++/(%&&&%#(((((((//(/((######################%###/////\n\
(/+/(##(/+,,,,,,,,,,,,,,,,,,+///(#%&&%##%%#(+,,,,,,++++++++///++++++++++++++++++++++++++++/////+++////////+/(%&&%%##########(((###((((((((################(/++/\n\
(//((##(/+,,,,,,,,,,,,,,,,,,+/++(#%%%###%%%(+,+////(((((########(((/////+++++++//////(((####%%####(((###((//(%&&&%##((((((((((#################(((((((##%#(/+++\n\
(++/(#(/+,,,,,,,,,,,,,,,,,,,+/++(##%%%##%&%(++//(((######%%%%%%####(((((////////((#####%%%%%%%%%%%#######(///#&&&%#(#####(/++//(//(((#%%%%#(////////+/#%%#(/+++\n\
/++(###(+,,.,,,,,,,,,,,,,,,,+/+/(#%&%%%%%&&%######(((((######%%%%%%####((/////((((####%%%%%%%%############%%%%&&&%((#####(/++//////((#####(/+++++++++/(###(+++/\n\
++/(##(/+,,,,,,,,,,,,,,,,,,+////(#%%#%&&&&%%###(/+++//((((#########%%%%%%#((//(##%%%%%%%%%%%%%%%%###((////(#%%%&&&&%###(#(+,+//++++/(#####(/++++++//+/(###(////\n\
##(####(+,,,,,,,,,,,,,,,,,,+///(#%%%%%&&&%#%%%#(///(#%%%%%%&&%%%%%##((#%&&&&&&&&&&%###%%%%%%&&%%%%%&%#(((((%&&%%&&&%###((/+.,,+,,,++(#####(/+,,,,+////(#%#(////\n\
((#####(+,,,,,,,,,,,,,,,,.,+/++/#%%%%%%&%#/((/+++/(#%#(((#%%%##(####(//#%%(/++/(%(#####(#%%%%#(((#%##((/((((((%((##((/, ..,,..,+/#####(/+,,,,+//++(#%%#////\n\
(/(#%#(/+,,,,,,,,,,,,,,,,,,+///(#%%%####%#/((/+,++///////(((((((((((/((#%(+,,,,+(%%##((((((((((((((((((////((((#%%#((##(((+,,+++,,,+/(####(/+,,,,,++++(#%%#////\n\
++(###(++,,,,,,,,,,,,,,,,,+////(#%&%###((#(/(/,,,+++++///////////++//#%%(+..,,,,+(%%%(//////////////////+++//((#%#((((#(((+,,+++,,,+/(####(//+++++++,+/#%%#(///\n\
+/###(/+,,,,,,,,,,,,,,,,,,+////(#%%%##(//((///+,,,,,,,++++++++++++++//#(+,...,,,+/##(//+++++++++++++++++++++/(###(//(##(((+..,,,,,,,/(##%##(/+++++/+,,/(#%#(///\n\
/(###(+,,,,,,,,,,,,,,,,.,,+//+/(#%&%##(/+/((/++,,,,,,,,,++++++++++++/((+,,..,,,+++(##//+++++++++++++++++++++/(#(//+/(##(#(,. ..,...,+(#####((/++++/+,,+(#%#(///\n\
/(###/+,,,,,.,,,,,,,,,,,,+///+/(#%&%#((/+,+((+,,,.,,,,,,,,+++++++++/((+,,,..,,,,+++(##/+++++++++++++++++++++/((/+++/(####(,  ..,...,+(#####(/+++++++,,+(#%#(///\n\
/(##(/+,,,,,,,,,,,,,,,,,,+/////#%&&%#((+,,+++///++,,,,,,,,,,+++++/(#(+,,,...,,,,,++/(%%(//++++++++++++++///((/++++,+(####(,   .....,+(#####(+,,,,,++++/(####///\n\
(####/+,,,,,,,,,,,,,,,,,,+////(#%%%%##/+,,,,..,,++///((((((#####%%#/,,,....,,,,,,,++/(######((((((((((////++++++++,,(####(,...,,,..,+(#####(/+,,,,+//++(%%##(//\n\
(#%%(/+,,,,,,,,,,,,,,,,,,+////(#%%%##(/+,,,,....,,,,++++////((###(+,,,,....,,,,,,++++/(((/////++++++++++++++++++++,+(####(+,.,,,,,,,+(#####(/++,,,+//++(#%%#(//\n\
#%%#/+,,,,,,,,,,,,,,,,,,+/////#%%%%##(/+++,,,,.,,,,,,,+++++/(((((/+++,,,,,,,,,,+++++///(((/++++++++++++++++++++++++/(####(/++++/++++/(#####(/++++++++++(#%%#((/\n\
#%#(/+,,,,,,,,,,,,,,,,,,++////#%%%%%#(++++,,,,,,,,,,+++++//((((/////((//+++++++///((((//////+++++,,+++++++++++++++/(######(//////////(#####(//+++++++++(#%%#(((\n\
#%#(/+,,,,,,,,,,,,,,,,,,+////(#%&&%##(/+++++,,,,,,++++++//(((//+++/(#%##((((((((#%%%#(///////+++++,+++++++++++/////(######(///////++/(######(/+++++++,,/#%%#((/\n\
#%#/++,,,,,,+++,,,,,,,,,+////(#%%%##((/+++/+++++++++++//(((//+++//(((##((((######%%#(//++++//+++++++++++++++++/////((###(((////////+/(#####(((//++++/++/##%#((/\n\
###//+,,,,,,,,,,,,,,,,,,/////(#%&%###(((((/++++++++////(((///////(((((((((((((#####(((///++++//+++++++++++++++/////(######(++++//////(#%%%%#(///+++///+/#%%%#(/\n\
%##(/++,+++,++++,++,,,,+/(///(#%%%###(####(/+++++/////(((///(((((((((((((((((((((###((((////++//+++++++++++++////+//(#%##(/+,,,+++///(#%%%%#/+,,,.,+/+,,(%%%#((\n\
###(/++++++++++++++++,,+((//(#%&&%%##((####(++++++/////((/((((((/////((((((((((((((((((((((/////+++++++++++++//((//(######(////////((###%%%#((/////(((((#%%%#(/\n\
((((/++++++++++++,,,,,,/((((##%%%%#########(++++++++++/(((######(//(((((//////((((((((((((((((//+++++++++++++/(##(((##%#####((((((((###%%%%##((((########%%%#(/\n\
/////++++++++++++++++++//////(//////////////+++++++++++//(((((//(((((((((((((############%%%##(///++++++++++/(########################################%%%%%%#(/\n\
////////++++///////////////////////++++++++++++++++++++++///++++++++++++/////(////((((((####%##(//+++++++++//////////////////////////((((((((((((((((########(/\n\
////////+++////////+++///+//+/////++/////////++++++++++++/+++++++++++++++++/////////////////((#((/+++++++/////////////+++++++++/////////////////////////////(//\n\
///////////////////////////////////////////////+++++++++++++++++++++++////(((///////////++++//((///++++///////////////////////////////////((((((((((//////////(\n\
////////////////////////////////////////////////++++++++++++++++,+++++//(((((((((//////++++++//////++/////////////++/////////////////////////////////////////((\n\
///////////+++//////////////////////////////////////+/++++++++,,,,++++//(((((((((////++++++++//////////////////////////////////////////////////////////////////\n\
//////////++++++/++++////////(#((((((((((((((///////////+++++++,,,+++//////((///////++++++++////////////////++++++++///////////////////////////////////////////\n\
///////////+//////++++++++///##((((#(((##((#((((#####(///////+++,,++++//////////////++++++++////////////////+++++////////////////////////++////////////////////\n\
/////////////////+//////////(##((########((##(((%&&&/////////++++++++////++//////++++++++/////(((((////////+++////////////(//(/////////+///////+/////////////\n\
/////////++//////++///++++++/#((###############%&&&&%(++////((////+++++++++++/////++++++////(((((((((#%#(///((#((((((((((((((((((/(/////////////+++////////////\n\
////////////////++++////////(#((###%%########%%&&&%%#+,,++//(((((///////////////////////(((####((///#&&&&%%###(////(((///((((//(((#(((((((#(((((((/////////////\n\
///////////++++++++++/++////(#((##########%%%%&%%&/+,,+++//((###(((//((((((((((((((((#######(/////(%&&&&&&&%%#((((((////((((((/(((/////(((//((##(////////////\n\
+++++///////////////////////(#((####%%%%%%%%%&%%%&/+,,,+++//((##%%%################%%%%%##((///////(####%&&&&&%%#(((((//(######((((((((((((((/(((////////////\n\
,,,,,,,,,,,,,,,+++++++//////###(#%%%%%%%%%%%&%%%&&%#/+,,,+++++//((#%%&&&%%%%%%%%%&&&&&%%#(((//////////(##//#%&@&&&&%%###((((####((((((((((((((///((////////////\n\
,,,,,,,,,,,,....,,,,,,,,,,/#%%%%%%%%%%%%%%%&%%%&@&%#(+,,,,++++++//(((##%%%%%%%%%%%%%%##((//////////////(((/(#%&@@&&&&%%%%########((((((((((((((//((////////////\n\
,,,,,,,,,,,,,,,.,,,+/((##%%%%##%%%%%%%%%%%%%%&&&&&%##/+,,,++++++++////(((((###((((((((//////////////++///(##%%%&&@@&&&&%%%%%%#######(((((((((((//((////////////\n\
,,,,,,,,,,,,,+/(#%%%%%%%%%%###%%%%%%%%%%&&%%%%&&&&%%##/+,,,+++++++++///////////////////////////////+++///(%&&%%%&&@@&&&&%%%%%%%%%%%%%%%%%%%##((//(((//////+////\n\
,,,,,,,,,+/#%%%%%%%%%%%%%%%%%%%%%%%%%%%&&%%%%&&&&%%%%##(+,,+++++++++++++//////////////////////////++++////#&&&%%%&&&@@&&&&%%%%%%%%%%%%%&&&&&&%%####(///////////\n\
+++++/(##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%&&%%%%&&&&%%%%%%%#(/+,,++++++++++++++++++++//////////+////+++++++//(#%&&&%%%%&&@@&&&&&&%%%%%%%%%%%%&&&&&&%%%#(///////////\n\
///(#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%&&%#%&&&%%%%%%%%%%%#(/+++++++++++++++++++++++//////////+++++++++++/(%&&&&&%%%%&&@@@&&&&&&%&&%%%%%%%%%&&@&&%%%#(//////////\n\
(#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%&%%%%%%%%%%%%%#(/+++++++++++++++++++++++++///+++++++++++++/(#%%&&&&%%%%%&&@@&&&&&&&&&&&%%%&&&&&&&&&&%%%#(//(((////\n\
%%&&&&%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%&%%%%%%%%%%%%%%%##(/+++++++++++++++++++++++++++++++++++++/(#%%%&&&&&%%%%%&&@&&&&&&&&&&&&&&%%&&&&&&&&%%%%(++///////\n\
%&&&&&%%%%%%%%%%%%%%%%%%%%%&&&%&&%%%%%%%%%%%%&%%%%##%%%%%%%%%%%%##(/++++++++++++++++++++++++++++++++/(#%%%%%%%%&&&%%%%%&&&&&&&&&&&&&&&&&&&&&&&&&&&&%%#/,,,,,,,,\n";

char *sweet_ascii = "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%(#(&&%@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/++++++,+,,,+++,++,++++/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@++++++,,,...,.,,,,,++,..+.,.,,,,(/&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&/+++++,,...,,,,,,.   ...,,,,,,,,,+,,+++#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(++++++,.,,+,..,,+,+,,,,,,,,,,+,+, ...,,+.,+@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@++++,,,,,+,,..++,,......,+,.,,+,,. ,+,,,....,,++++@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@++++++,,.,+,..+++,+,.+++,. ..,,,....,+,..,,+,+,+,,.,+#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/+,+++++,.,+.,,,+++++,,,+..+,+,,..,,.,,,,,,,+,,,,,,,,,,,,@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@&%@%#@@%@@&@@@@@@@@@@@@@@@@@@@@@@@+,+++,+++,,,+,,,.. .,+  ...,  .,,++,.. ....   .,. .,+,,,+,.(%&@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@/+(,++,+,,,,+,,,,++,++++,+++(+/@#&@&@@@@@@%++,,,++++++,,,,,,+,+++,+++++,,,,.,. ,+.   .+,,,,,,+,++,,,,,,,+,/@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@+//,++.,,,+,+++++,,,,,,++,,,,,,,,++++,,+.+,,+,+%#/,,,+,,+,,.,,,,,,+,,,.   .,,+,,,,,,....,,+......,+,.,,.,.,,.,+,..,..(/#@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@%%,+++,,,,,,,+,+,.....,,+,+,.,,,,,,+,,,,,,....,,+,,,,,.+,,,.,,,,+,,,,,,,,..,,.,++. ,. .,+,,,,+,++++,+,,++,,..,,,,,+..,+,+,,,,.,+%@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@&,,+,.+,,+++,,+++,++,,+++,,,,+,,,,,,,+,.,,.,++,,++++,,,,++,.,.,,,,,,,,,+,,,,+,,+++.,,,..,.,..+++,...  .+++,,....,,.+,,+++,.,,,+.,..,/(@@@@@@@@@@@@@\n\
@@@@@@@@@/++,,,,,++,.,++,,,,+++,,,....,,.,.,,,,,,,..,,,.....,+++,,,+,,....,,,,.,,,.,,,,,+,.+,++,,,,,,+,+,,,..,,,...   ..+++,+,,,+++,,++,++,.,,+,,+,+@@@@@@@@@@@\n\
@@@@@@@,++,,,,,,+++++,+++,,+,+,.,,,.,.,,,,,,,,,+,,++,,...,+,.., .,,+,..,..,.#/,.,,,,,,,,++,+,.. .,,+,++,,,+.,+.,+++..,+++ ..,++.,+++,.. +,  ,++++,,,./@@@@@@@@@\n\
@@@@/,,,++,,+,++++,,,,,,,,..,+,.,+++++,,,+++,,++++,,,....,...+...,,,.,......&&+,,,,,,...,,++++,.,   ,,.,+,+,.++++++++,+.,,+,,+++,,,++++,,.,+,,,+,++,,.,%@@@@@@@\n\
@@%,,,,,,,+,,+++,,,,++,,,+...,,,,,,,+,,,,,,,,,,,,+,,,,....,,,,...,,,,,,.....&&&,.,,,,,,...++,+++,+,,,.,,.++++,,,++++,+,.,,++,,+,++,,+,++,,+,,+,.+,,,,,,.+%@@@@@\n\
@(,+,,+,,,+++++,,,,+,,..,..,++,,++,++,,,,,,....,,,+,,..,,++,.,,,,. .,,,,,,.,%&&.,,,,,,,. .,++++,,,,,,,..+++,,+,......,,. . . ,,,   ..+,+,++,.,,++,,,,,..(@@@@\n\
%,,,.,,,,+,,+++,,,+,.,,,,,,+,,,+,.,,++,++,,,,,.,,,+,,,,+,,.,,+,. ...,,.,,,,./%&&&%..,,,,+,,...,,+.,++,,...,++++,,,,.,,,,,,,.,,,.,++++,+.,,,,..,++,,++,,,,.,(@@@\n\
,,,,,,,+++,,++,,.+,,,++.,,.++,.,+,,,..,...,+..,.,,,,,.,,..,+,,,+.,,.,,,,,,.,.#&&&&%+...,.,+,,...,+,,+,++,,,++,.,,,.....,,+,,.  ,,+,,...,+++++,,.  ., ,,,,+.,(@@\n\
++,,/,,++++++,,,,,,,,,,,+,+,,,+++,++,,,,,+,,...,,,,.,,,.,+,. .,, ,+....,,,,,..%&&&&...,,,,.,,,..,+,,+,,.,,,. ,+,,,,,++,...    .,..,+,,,,.,++++,,,.,,,+,,,../@\n\
,,,++,+,,+,+,,++,++++,++,+,,++++,,,+++......,,.,....,,......,,   ,,.  ...,,,,,.%&&&&%(.....,,,..,+,,,,,+,.,...,,,+++++,. .,,,+,,,,++,,+,,...,++++++,,+,,,,,,,,/\n\
,,,,+,,+,,+,++,,.,,,..,+++,......,,++,,,,,,,,,,,+++++,,,.......,,,,.,. ....,,,,.%%%%%%%#,..,.,+,. ..+,.,+++++,.+,+,+,,,,,,,,,,,,,..., .,,,,,.  .,+...,+,,+,,,.,\n\
,,,,+,+,,,+,+,.,++,,+++++,,.,,,..,+,..,+,+,,,,,,,,+,,,+,,..,,,,..,,.,.  ..,.,,,..#%%%%%%%#.......+,..,,,.,+,,,+, .,.,+..,,,+,+...,,,,.,.,+++,+...,++++,,++,,,..\n\
,,,,,,.,++,,+++,,...,,,,,,,++,,++,,,.,.+,...,,,,,..++,,,+,+.,,,,. ..,. ......,,,,.#%%%%%%%#(,...,..,,,...,,,,..,,,+,,,+,+,,,,+,,,,,++,.,...,.,+++,,,,,,,,+,,,.,\n\
,,,.,,+.,,,++++++,,+,,+,,+++,,+.,,,+.,,,.,,,++,,,+++,,,,+,. ..,,,.,,.. ,......,,,.,,#%%%%%%%##+.......+,,.,,,,,,.,++,+,,,++,,,,+++..,,,+,++,+,..,,,,,+,,+,,,,..\n\
,+.,..,,,+,.+,+,,++++++,+,,+++,,,,,.,,,,++,,,,.,++..,..,,. ,+,++,. .,.     ...,.,,,,.#%%%%%%%%#(+......,.+,,.,,+,++++,++.,+,+,,,. ,,,.,,,+++++,,,,,,++,,+.,,,,.\n\
,,,,...,..+,,,+,,+,,,,,++++,...,,,,,+++++,.,++,,,,,,,,,.. .,.. .. ,.    .,.........,,..(%%%%%%%##(/,....,...,,.,.,+,+++++,,+++,+,.,+++,,..+,,..+,..,+,+...,,,,,\n\
,,+,....,..,,,.+,.,+++,+++,,+,,,++++++++,,..,,,,.,,,++,++,,,,,,+,,,++,.,..,. .....,.,,,..#%%%%%%%##(/,.......+,+,,.,,,,++++,....,,,,,,..,,,,,+,+,,,,,,..,,,+,,,\n\
,+,+#/,,,....+...,..,,.+,.++,,+++,++,++++,,,,+,,,,..,,.,,,,+,,,,,.,,.,,,. ..  ......,,,..,,/#%%%%%###((/,... .....,....+.++,+++++,,,++,,,/+.......,,+,,+++,,,.,\n\
++,.,%%(,.,....,..,.,.,,..,..+,,++,,+,,,,+++,+,,,+,,,,,,.,,.,+..,,.,,++...   . ....,,...,,,.,+#%%######((/+,.........,...,,.,+.,+,,++++,++,,,,.,,+++++++,,,,...\n\
,,,+,,(%%#/,,,.,.......,,.,..,..,..,. ,,..,..,..,,.,,..,..,....,.............. .  ........,,+.. /##%%%%###((/++........ ...,..,,..,+.,,.+,+,,+++,,,+,,,,,.,..,&\n\
,,,,,,,.(#%%#(/,,.,,.,...........,....,.,,,....,,,...,,,,+...........,....,+,.     .,...... .,.,, .+((######(((//++..............,,.....,,,,.+,,,,,,......,,+@@\n\
+,,,,,,,,.+%#####(//+,,,,...........,..........................,.,,.,+++++,.         .+,,,......,,,, ./(((#####(((///+,,,................,.,,...........,,(@@@@\n\
#,,,,+++,.,,/(######(((//+,,,..,..........................,.,,,+///////+,.           ..,+#+...... .,,.,. ,/((##((((((///+/++,.,..,......,....,....,.,,,(@@@@@@@\n\
@@,,,,,,+,+,,..,(((#######((((////+++++++++++++,+++++//////((((((((/+,.            ..,/@@@%,...,....,,,,. .,+/////(((((/////++++++++,,,,.,..,.,/+/.,,@@@@@@@@\n\
@@@+,..,,,,,,,.,,,..//(############((((((((((((((((((((((#(((((+,  .          ... ..,@@@@@@@@%%%,...... .,,..,...  .,+///(((((((((((/(((((((####(,.,.,(@@@@@@@@\n\
@@@@@,,....,,,,++,,,,.....,+/(((((((((#(((((((#((((((////++........ ..............,%@@@@@@@@@@@@#,.........,,.,...     .,,++///(((((((#(((+.......,/@@@@@@@@@\n\
@@@@@@@%,,...,.,,,+,,,,,.,,,,,,.., ...,..++++,,   ..  .......,..,,.,,,,.,.....,,,%@@@@@@@@@@@@@@@@@@@+,...........,.............      ...........,,,@@@@@@@@@@@\n\
@@@@@@@@@@,,.,........,++,,+++,,,,,+,,+....,,,,,,.,,,,,++,,,,,,,,..........,,#@@@@@@@@@@@@@@@@@@@@@@@@@@,,+,............,.,...................,,,+&@@@@@@@@@@@@\n\
@@@@@@@@@@@@@&.,..,.......,,,,,+,++,+,++++++++++,,++++,,,+,,...........,,/#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%/#,.............. ...,.....,....,.,(@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@%&+,,.,.....,..................................,..,,/@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%+,.....,..,,......,..,,,/&@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@#@%(%,,+,,,..,..................,,,,,.#(/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&+,(+,(/(&@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@@&%@%#@#+@&+&@+%@/%@#%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n";

int min(int a, int b){
	return (a < b ? a : b);
}

//DOES NOT NULL TERMINATE OR STOP RECVing ON \n or NULL
int recv_buf(int fd, char *dst, unsigned int len){
	int res;
	char chr;
	int numr = 0;
	for (unsigned int i = 0; i < len; i++){
		res = recv(fd, &chr, 1, 0);
		if (res != 1){
			printf("Something terribly bad happened!\n");
			fflush(stdout);
			exit(-1);
		}
		dst[i] = chr;
		numr++;
	}

	return numr;
}

int recv_buf_throwaway(int fd, unsigned int len){
	int res;
	char chr;
	for(unsigned int i = 0; i < len; i++){
		res = recv(fd, &chr, 1, 0);
		if (res != 1){
			printf("Something terribly bad happened!\n");
			fflush(stdout);
			exit(-1);
		}
	}

	return 0;
}

//DOES NOT STOP SENDING ON \n or NULL
int send_buf(int fd, char *src, unsigned int len){
	int res;
	char chr;
	int numw = 0;
	for (unsigned int i = 0; i < len; i++){
		chr = src[i];
		res = send(fd, &chr, 1, 0);
		if (res != 1){
			printf("Something terribly bad happened!\n");
			fflush(stdout);
			exit(-1);
		}
		numw++;
	}
	return numw;
}

//STOPS RECVing ON NULL, reads max len-1 and \0 terminates
int recv_string(int fd, char *dst, unsigned int len){
	int res;
	char chr;
	int numr = 0;

	if (!len)
		return 0;

	unsigned int i;
	for (i = 0; i < (len-1); i++){
		res = recv(fd, &chr, 1, 0);
		if (res != 1){
			printf("Something terribly bad happened!\n");
			fflush(stdout);
			exit(-1);
		}
		dst[i] = chr;
		numr++;
		if (chr == 0){
			return numr;
		}
	}
	dst[i] = 0;

	return numr;
}

//STOP SENDING ON NULL, SEND MAXIMUM len-1 plus one \0
int send_string(int fd, char *src, unsigned int len){
	int res;
	char chr;
	int numw = 0;

	if (!len)
		return 0;

	unsigned int i;
	for (i = 0; i < (len-1); i++){
		chr = src[i];
		res = send(fd, &chr, 1, 0);
		if (res != 1){
			printf("Something terribly bad happened!\n");
			fflush(stdout);
			exit(-1);
		}
		numw++;

		if (chr == 0){
			return numw;
		}
	}
	chr = 0;
	send(fd, &chr, 1, 0);
	return numw;
}




void read_buf_until(char *dst, unsigned int len, unsigned char delimit){
	int res;
	char chr;
	for (unsigned int i = 0; i < len; i++){
		res = read(0, &chr, 1);
		if (res != 1){
			exit(1);
		}
		if (delimit == chr){
			dst[i] = 0;
			return;
		}
		dst[i] = chr;
	}

}

void read_buf(char *dst, unsigned int len){
	int res;
	char chr;
	for (unsigned int i = 0; i < len; i++){
		res = read(0, &chr, 1);
		if (res != 1){
			exit(1);
		}
		dst[i] = chr;
	}

}



int read_int(){
	char s[8];
	memset(s, 0, 8);
	read_buf_until(s, 8, 10);
	return atoi(s);
}

void print_banner(){
	puts(banner_ascii);
	printf("Welcome to the House of Sweets and Selfies!\n");
	printf("Whether you are here because you have a serious case of the munchies\nor because you are an Instagram Influencer(tm), we have everything you'll need!\n");
	fflush(stdout);
}

void print_menu(){
	printf("What would you like to do next?\n");
	printf("(1) Sweets!\n");
	printf("(2) Selfies!\n");
	printf("(3) Leave\n");
	fflush(stdout);
}

void print_selfies_menu(){
	printf("(1) Add Selfie\n");
	printf("(2) Edit Selfie\n");
	printf("(3) View Selfie\n");
	printf("(4) Delete Selfie\n");
	printf("(5) Nevermind\n");
	fflush(stdout);
}

void print_sweets_menu(){
	printf("(1) Order Cake\n");
	printf("(2) Modify Recipe\n");
	printf("(3) Bake Cake\n");
	printf("(4) Throw Cake Into Trash\n");
	printf("(5) Lost my appetite\n");
	fflush(stdout);
}

int find_first_free_sweet_idx(){

	for(int i = 0; i < 32; i++){
		if (sweets[i].allocated == 0){
			return i;
		}
	}

	return -1;
}

// recv_buf, send_buf, sweets[]. sweet_ascii
void sweet_thread_handle_order(){

	//NOTE: we always consume every field first, then we handle
	
	int typ, def, size;

	recv_buf(sweet_thread_recv_fd, (char *) &typ, 4);
	recv_buf(sweet_thread_recv_fd, (char *) &def, 4);
	recv_buf(sweet_thread_recv_fd, (char *) &size, 4);
	
	int idx = find_first_free_sweet_idx();

	if (idx == -1){
		return;
	}

	if (typ == 1){
		if (def == 1){
			sweets[idx].allocated = 1;
			sweets[idx].recipe = sweet_ascii;
			sweets[idx].size = -1;
			sweets[idx].used_size = -1;
			sweets[idx].type = 1;
		}
		else{
			//note: 0x400000 not a typo, we want to trigger huge allocations.
			if ((0 < size) && (size <= 0x400000)){
				sweets[idx].type = 1;
				sweets[idx].recipe = malloc(size);
				sweets[idx].allocated = 1;
				sweets[idx].size = size;
				sweets[idx].used_size = -1; //this field is unused for type 1
				sweets[idx].recipe[0] = 0;
			}
		}
	}

	else if (typ == 2){
		if((0 < size) && (size <= 0x20000)){
			sweets[idx].recipe = malloc(size);
			sweets[idx].allocated = 1;
			sweets[idx].size = size;
			sweets[idx].used_size = 0;
			sweets[idx].type = 2;
		}
	}

	return;
}

//no bug in this one
void sweet_thread_handle_modify(){

	int idx;
	recv_buf(sweet_thread_recv_fd, (char *) &idx, 4);
	int intended_size;
	recv_buf(sweet_thread_recv_fd, (char *) &intended_size, 4);

	if (idx < 0 || idx > 31){
		//the idx is bad, so we just need to dump the sent stuff somewhere.	
		recv_buf_throwaway(sweet_thread_recv_fd, intended_size);
	}

	else{
		if (sweets[idx].type == 1){

			if (sweets[idx].recipe == sweet_ascii){
				//we don't allow editing this one!
				recv_buf_throwaway(sweet_thread_recv_fd, intended_size);
			}

			if (intended_size > sweets[idx].size){
				recv_buf_throwaway(sweet_thread_recv_fd, intended_size);
				}
			else{
				int num_read = recv_string(sweet_thread_recv_fd, sweets[idx].recipe, intended_size);
				recv_buf_throwaway(sweet_thread_recv_fd, intended_size - num_read);
			}
		}

		else if (sweets[idx].type == 2){
			if (intended_size > sweets[idx].size){
				recv_buf_throwaway(sweet_thread_recv_fd, intended_size);
			}
			else{
				recv_buf(sweet_thread_recv_fd, sweets[idx].recipe, intended_size);
				sweets[idx].used_size = intended_size;
			}
		}
	}

	return;
}

void sweet_thread_handle_trash(){
        //NOTE: we always consume every field first, then we handle

        int idx;

        recv_buf(sweet_thread_recv_fd, (char *) &idx, 4);

        if (idx < 0 || idx > 31){
                return;
        }

	if (sweets[idx].allocated == 1){
		if (sweets[idx].recipe != sweet_ascii){
			free(sweets[idx].recipe);
		}
		sweets[idx].allocated = 0;
		sweets[idx].recipe = NULL;
		sweets[idx].size = 0;
		sweets[idx].used_size = 0;
		sweets[idx].type = 0;
	}


}	

void sweet_thread_handle_bake(){

	int idx;

	recv_buf(sweet_thread_recv_fd, (char *) &idx, 4);

	//handle erroneous idx
	if (idx < 0 || idx > 31){
		int is_valid = -1;
		send_buf(sweet_thread_send_fd, (char *) &is_valid, 4);
		return;
	}

	if (sweets[idx].allocated == 1){
		fflush(stdout);
		if (sweets[idx].type == 1){
			if (sweets[idx].recipe == sweet_ascii){
				int is_def = 1;
				send_buf(sweet_thread_send_fd, (char *) &is_def, 4);
				return;
			}
			else{
				int is_def = 0;
				send_buf(sweet_thread_send_fd, (char *) &is_def, 4);

				if( (sweets[idx].size < 0) || (sweets[idx].size > 0x2000)){
					int inv_size = -1;
					send_buf(sweet_thread_send_fd, (char *) &inv_size, 4);
					return;
				}
				else{
					//Note that recv_string might not read this far
					send_buf(sweet_thread_send_fd, (char *) &(sweets[idx].size), 4);
					int typ = 1;
					send_buf(sweet_thread_send_fd, (char *) &typ, 4);
					//Send only until first \0!
					send_string(sweet_thread_send_fd, (char *) sweets[idx].recipe, sweets[idx].size);
				}
			}
		}
		else if (sweets[idx].type == 2){

			//never the def
			int is_def = 0;
			send_buf(sweet_thread_send_fd, (char *) &is_def, 4);

                	if( (sweets[idx].size < 0) || (sweets[idx].size > 0x2000)){
                                int inv_size = -1;
                                send_buf(sweet_thread_send_fd, (char *) &inv_size, 4);
                       		return;
               		}

			//meant to be smart, but also manages to not detect corrupt used_size this way..
			int send_size = min(sweets[idx].used_size, sweets[idx].size);
			send_buf(sweet_thread_send_fd, (char *) &send_size, 4);

			int typ = 2;
			send_buf(sweet_thread_send_fd, (char *) &typ, 4);

			send_buf(sweet_thread_send_fd, (char *) sweets[idx].recipe, send_size);
	
		}
	}
	else{
		int is_valid = -1;
		send_buf(sweet_thread_send_fd, (char *) &is_valid, 4);
	}

	return;
}

void* sweets_threadfn(void *arg){

	//First connect to the main thread's listener where we can send responses

	struct sockaddr_un saddr = {AF_UNIX, "/data/local/tmp/socket_bakery_to_shop"};
	sweet_thread_send_fd = socket(AF_UNIX, SOCK_STREAM, 0);

	//waiting out barrier
	while(1){
		if (main_started_listening_to_sweet == 1){
			break;
		}
		sleep(1);
	}

 	connect(sweet_thread_send_fd, (struct sockaddr *)&saddr, sizeof(saddr));

	//Next setup the listener where the main thread can send commands
		
	int recvfd = socket(AF_UNIX, SOCK_STREAM, 0);
	if (recvfd < 0){
		printf("Ajve somebody drank all our milkshake!\n");
		fflush(stdout);
		exit(-1);
	}

	struct sockaddr_un saddr2 = {AF_UNIX, "/data/local/tmp/socket_shop_to_bakery"};
	bind(recvfd, (struct sockaddr *)&saddr2, sizeof(saddr2));
	listen(recvfd, 1);

	sweet_started_listening_to_main = 1; //barrier for the connect

	sweet_thread_recv_fd = accept(recvfd, NULL, NULL);

	char buf[4];
	memset(buf, 0, 4);
	while(1){
		recv_buf(sweet_thread_recv_fd, buf, 4);

		if (memcmp(buf, "ORDR", 4) == 0){
			sweet_thread_handle_order();
		}

		if (memcmp(buf, "MODY", 4) == 0){
			sweet_thread_handle_modify();
		}

		if (memcmp(buf, "TRSH", 4) == 0){
			sweet_thread_handle_trash();
		}

		if (memcmp(buf, "BAKE", 4) == 0){
			sweet_thread_handle_bake();
		}
		
	}
	return NULL;
}

int find_first_free_selfie_idx(){

	for(int i = 0; i < 32; i++){
		if (selfies[i].allocated == 0){
			return i;
		}
	}

	return -1;
}

/*
struct selfie_s {
        unsigned allocated;
        unsigned size;
        unsigned type; // old-school / modern
        char *image;
};
*/

// recv_buf, send_buf, selfies[]. selfie_ascii
void selfie_thread_handle_add(){

	//NOTE: we always consume every field first, then we handle
	
	int typ, def, size;

	recv_buf(selfie_thread_recv_fd, (char *) &typ, 4);
	recv_buf(selfie_thread_recv_fd, (char *) &def, 4);
	recv_buf(selfie_thread_recv_fd, (char *) &size, 4);
	
	int idx = find_first_free_selfie_idx();

	if (idx == -1){
		return;
	}

	if (typ == 1){
		if (def == 1){
			selfies[idx].allocated = 1;
			selfies[idx].image = selfie_ascii;
			selfies[idx].size = -1;
			selfies[idx].used_size = -1;
			selfies[idx].type = 1;
		}
		else{
			if ((0 < size) && (size <= 0x2000)){
				selfies[idx].type = 1;
				selfies[idx].image = malloc(size);
				selfies[idx].allocated = 1;
				selfies[idx].size = size;
				selfies[idx].used_size = -1; //this field is unised for type 1
				selfies[idx].image[0] = 0;
			}
		}
	}

	else if (typ == 2){
		if((0 < size) && (size <= 0x2000)){
			selfies[idx].image = malloc(size);
			selfies[idx].allocated = 1;
			selfies[idx].size = size;
			selfies[idx].used_size = 0;
			selfies[idx].type = 2;
		}
	}

	return;
}

//this is where the bug is: if modern type, it will add a "png header" in, which takes away from size, but is still willing to read total size,
//because it first checks that against the total.
void selfie_thread_handle_edit(){

	int idx;
	recv_buf(selfie_thread_recv_fd, (char *) &idx, 4);
	int intended_size;
	recv_buf(selfie_thread_recv_fd, (char *) &intended_size, 4);

	if (idx < 0 || idx > 31){
		//the idx is bad, so we just need to dump the sent stuff somewhere.	
		recv_buf_throwaway(selfie_thread_recv_fd, intended_size);
	}

	else{
		if (selfies[idx].type == 1){

			if (selfies[idx].image == selfie_ascii){
				//we don't allow editing this one!
				recv_buf_throwaway(selfie_thread_recv_fd, intended_size);
			}

			if (intended_size > selfies[idx].size){
				recv_buf_throwaway(selfie_thread_recv_fd, intended_size);
				}
			else{
				int num_read = recv_string(selfie_thread_recv_fd, selfies[idx].image, intended_size);
				//throw away the difference! (Frontend might have sent too much)
				recv_buf_throwaway(selfie_thread_recv_fd, intended_size - num_read);
			}
		}

		else if (selfies[idx].type == 2){
			if (intended_size > selfies[idx].size){
				recv_buf_throwaway(selfie_thread_recv_fd, intended_size);
			}
			//if the PNG HDR doesnt fit, we skip it.
			else if (selfies[idx].size < PNG_HDR_size){
				recv_buf(selfie_thread_recv_fd, selfies[idx].image + PNG_HDR_size, intended_size);
				selfies[idx].used_size += intended_size;
			}
			//otherwise we add it - but this is where the bug is!
			else{
				//THIS IS THE VULN, obviously: does not check PNG_HDR_size + intended_size together
				memcpy(selfies[idx].image, PNG_HDR, PNG_HDR_size);
				selfies[idx].used_size = PNG_HDR_size;
				recv_buf(selfie_thread_recv_fd, selfies[idx].image + PNG_HDR_size, intended_size);
				selfies[idx].used_size += intended_size;
			}
		}
	}

	return;
}

void selfie_thread_handle_delete(){
        //NOTE: we always consume every field first, then we handle

        int idx;

        recv_buf(selfie_thread_recv_fd, (char *) &idx, 4);

        if (idx < 0 || idx > 31){
                return;
        }

	if (selfies[idx].allocated == 1){
		if (selfies[idx].image != selfie_ascii){
			free(selfies[idx].image);
		}
		selfies[idx].allocated = 0;
		selfies[idx].image = NULL;
		selfies[idx].size = 0;
		selfies[idx].used_size = 0;
		selfies[idx].type = 0;
	}


}	

//TODO: this is where we hvae to return the buf so have to pay attention to ascii.
//We will in all cases return size bytes though: for ascii, size-1 + \0, for normal: size bytes.
void selfie_thread_handle_view(){

	int idx;

	recv_buf(selfie_thread_recv_fd, (char *) &idx, 4);

	//handle erroneous idx
	if (idx < 0 || idx > 31){
		int is_valid = -1;
		send_buf(selfie_thread_send_fd, (char *) &is_valid, 4);
		return;
	}

	if (selfies[idx].allocated == 1){
		if (selfies[idx].type == 1){
			if (selfies[idx].image == selfie_ascii){
				int is_def = 1;
				send_buf(selfie_thread_send_fd, (char *) &is_def, 4);
				return;
			}
			else{
				int is_def = 0;
				send_buf(selfie_thread_send_fd, (char *) &is_def, 4);

				if( (selfies[idx].size < 0) || (selfies[idx].size > 0x2000)){
					int inv_size = -1;
					send_buf(selfie_thread_send_fd, (char *) &inv_size, 4);
					return;
				}
				else{
					//Note that recv_string might not read this far
					send_buf(selfie_thread_send_fd, (char *) &(selfies[idx].size), 4);
					int typ = 1;
					send_buf(selfie_thread_send_fd, (char *) &typ, 4);
					//Send only until first \0!
					send_string(selfie_thread_send_fd, (char *) selfies[idx].image, selfies[idx].size);
				}
			}
		}
		else if (selfies[idx].type == 2){

			int is_def = 0;
			send_buf(selfie_thread_send_fd, (char *) &is_def, 4);

                	if( (selfies[idx].size < 0) || (selfies[idx].size > 0x2000)){
                                int inv_size = -1;
                                send_buf(selfie_thread_send_fd, (char *) &inv_size, 4);
                       		return;
               		}

			//meant to be smart, but also manages to not detect corrupt used_size this way..
			int send_size = min(selfies[idx].used_size, selfies[idx].size);
			send_buf(selfie_thread_send_fd, (char *) &send_size, 4);

			int typ = 2;
			send_buf(selfie_thread_send_fd, (char *) &typ, 4);

			send_buf(selfie_thread_send_fd, (char *) selfies[idx].image, send_size);


	
		}
	}
	else{
		int is_valid = -1;
		send_buf(selfie_thread_send_fd, (char *) &is_valid, 4);
	}

	return;
}

void* selfie_threadfn(void *arg){
	
	//First connect to the main thread's listener where we can send responses

	int ret;

	struct sockaddr_un saddr = {AF_UNIX, "/data/local/tmp/socket_social_to_shop"};
	selfie_thread_send_fd = socket(AF_UNIX, SOCK_STREAM, 0);

	//barrier for main to starting listening
	while(1){
		if (main_started_listening_to_selfie == 1){
			break;
		}
		sleep(1);
	}

 	ret = connect(selfie_thread_send_fd, (struct sockaddr *)&saddr, sizeof(saddr));

	if (ret < 0){
		printf("selfie_threadfn connect fail\n");
		fflush(stdout);
		exit(-1);
	}

	//Next setup the listener where the main thread can send commands
		
	int recvfd = socket(AF_UNIX, SOCK_STREAM, 0);
	if (recvfd < 0){
		printf("This just in: people only care about kittens, our business model is a failure!\n");
		fflush(stdout);
		exit(-1);
	}

	struct sockaddr_un saddr2 = {AF_UNIX, "/data/local/tmp/socket_shop_to_social"};
	ret = bind(recvfd, (struct sockaddr *)&saddr2, sizeof(saddr2));
	if (ret < 0){
		printf("selfie_threadfn bind fail\n");
		fflush(stdout);
		exit(-1);
	}
	ret = listen(recvfd, 1);
	if (ret < 0){
		printf("selfie_threadfn listen fail\n");
		fflush(stdout);
		exit(-1);
	}

	//barrier for main to detect
	selfie_started_listening_to_main = 1;

	selfie_thread_recv_fd = accept(recvfd, NULL, NULL);

	if (selfie_thread_recv_fd < 0){
		printf("selfie_threadfn accept fail\n");
		fflush(stdout);
		exit(-1);
	}

	char buf[4];
	memset(buf, 0, 4);
	while(1){
		recv_buf(selfie_thread_recv_fd, buf, 4);

		if (memcmp(buf, "ADDS", 4) == 0){
			selfie_thread_handle_add();
		}

		if (memcmp(buf, "EDIT", 4) == 0){
			selfie_thread_handle_edit();
		}

		if (memcmp(buf, "TRSH", 4) == 0){
			selfie_thread_handle_delete();
		}

		if (memcmp(buf, "VIEW", 4) == 0){
			selfie_thread_handle_view();
		}
		
	}
	return NULL;
}

void send_selfie_add_command(int type, int is_default, int size){

	int typ = type;
	int def = is_default;
	int siz = size;

	send_buf(main_thread_selfie_send_fd, "ADDS", 4);
	send_buf(main_thread_selfie_send_fd, (char *) &typ, 4);
	send_buf(main_thread_selfie_send_fd, (char *) &def, 4);
	send_buf(main_thread_selfie_send_fd, (char *) &siz, 4);
	
	printf("Add command sent!\n");
	fflush(stdout);
}

//async
void process_selfie_add(){

	printf("Select selfie type:\n(1) old-school (2) modern\n");
	fflush(stdout);

	int type = read_int();

	//old-school
	if (type == 1){
		printf("Do you want to use the default picture? (1) Yes (0) No\n");
		fflush(stdout);
		int use_def = read_int();
		if (use_def == 1){
			//we know the type and that it's the def, so that's enough to send the command.
			send_selfie_add_command(type, use_def, 0);
		}
		else{
			//we need to get the size and then read it in.
			printf("What will be the size of the selfie image?\n");
			fflush(stdout);
			int size = read_int();

			//we know the type and size, so that's enough to send the command.
			send_selfie_add_command(type, use_def, size);
		}
	}

	else if (type == 2){
		printf("What will be the size of the selfie image?\n");
		fflush(stdout);
		int size = read_int();

		//we know the type and size, so that's enough to send the command.
		send_selfie_add_command(type, 0, size);
	}

	else{
		printf("That's not a valid selfie-type! Pay attention, influencing people is hard work!\n");
		fflush(stdout);
	}

	return;
}

void send_selfie_edit_command(int idx, int size){

	int id = idx;
	int siz = size;

	send_buf(main_thread_selfie_send_fd, "EDIT", 4);
        send_buf(main_thread_selfie_send_fd, (char *) &id, 4);
        send_buf(main_thread_selfie_send_fd, (char *) &siz, 4);
        send_buf(main_thread_selfie_send_fd, (char *) selfie_image_buffer, size);
}

//async
void process_selfie_edit(){
	printf("Which selfie do you want to edit?\n");
	fflush(stdout);
	int idx = read_int();
	printf("How large is your edit?\n");
	fflush(stdout);
	int size = read_int();

	//note: the 0x2000 can of course be too large for the given selfie;
	//this is handled by the threadfn not here
	if (size < 0 || size > 0x2000){
		printf("Sorry, I can't handle that!\n");
		fflush(stdout);
		return;
	}
	else{
		memset(selfie_image_buffer, 0, 0x2000);
		read_buf(selfie_image_buffer, size);
		send_selfie_edit_command(idx, size);
	}


	return;
}

//sync
void process_selfie_view(){

	printf("Which selfie would you like to view?\n");
	fflush(stdout);

	int idx = read_int();
	if (idx < 0 || idx > 31){
		printf("Sorry, I can't handle that!\n");
		fflush(stdout);
		return;
	}

	send_buf(main_thread_selfie_send_fd, "VIEW", 4);

	send_buf(main_thread_selfie_send_fd, (char *) &idx, 4);

	printf("Waiting for the response from the social media team...\n");
	fflush(stdout);

	int is_def = -1;
	recv_buf(main_thread_selfie_recv_fd, (char *) &is_def, 4);

	if (is_def == -1){
		printf("Sorry, it looks like our social media experts can't find that selfie!\n");
		fflush(stdout);
		return;
	}

	if (is_def == 1){
		printf("Oh here you go! We are known for our very fast service!\n");
		fflush(stdout);
		puts(selfie_ascii);
		fflush(stdout);
		return;
	}

	int size = -1;

	recv_buf(main_thread_selfie_recv_fd, (char *) &size, 4);

	if (size < 0 || size > 0x2000){
		printf("Sorry, it looks like our social media experts managed to ruin that selfie! Oops!\n");
		fflush(stdout);
		return;
	}

	int type = -1;
	recv_buf(main_thread_selfie_recv_fd, (char *) &type, 4);

	memset(selfie_image_buffer, 0, 0x2000);

	if (type == 1){
		recv_string(main_thread_selfie_recv_fd, (char *) selfie_image_buffer, size);
		puts(selfie_image_buffer);
	}
	else{
		recv_buf(main_thread_selfie_recv_fd, (char *) selfie_image_buffer, size);
		write(1, selfie_image_buffer, size);
	}

	return;
}

//async
void process_selfie_delete(){

	printf("Which selfie would you like to remove? (Idx)\n");
	fflush(stdout);

	int idx = read_int();

	send_buf(main_thread_selfie_send_fd, "TRSH", 4);
	send_buf(main_thread_selfie_send_fd, (char *) &idx, 4);

	return;
};

void process_selfies_command(){

	int choice = read_int();
	switch(choice){

		//add, edit, view, delete

		case 1:
			process_selfie_add();
			break;
		case 2:
			process_selfie_edit();
			break;
		case 3:
			process_selfie_view();
			break;
		case 4:
			process_selfie_delete();
			break;
		default:
			break;
	}
}

void send_cake_order_command(int type, int is_default, int size){

	int typ = type;
	int def = is_default;
	int siz = size;

	send_buf(main_thread_sweet_send_fd, "ORDR", 4);
	send_buf(main_thread_sweet_send_fd, (char *) &typ, 4);
	send_buf(main_thread_sweet_send_fd, (char *) &def, 4);
	send_buf(main_thread_sweet_send_fd, (char *) &siz, 4);
	
}

//async command
void process_cake_order(){

	printf("Select cake type:\n(1) classic (2) hipster\n");
	fflush(stdout);

	int type = read_int();

	//old-school
	if (type == 1){
		printf("Do you want to use the default picture? (1) Yes (0) No\n");
		fflush(stdout);
		int use_def = read_int();
		if (use_def == 1){
			//we know the type and that it's the def, so that's enough to send the command.
			send_cake_order_command(type, use_def, 0);
		}
		else{
			//we need to get the size and then read it in.
			printf("What will be the volume of the cake?\n");
			fflush(stdout);
			int size = read_int();

			//we know the type and size, so that's enough to send the command.
			send_cake_order_command(type, use_def, size);
		}
	}

	else if (type == 2){
		printf("What will be the volume of the cake?\n");
		fflush(stdout);
		int size = read_int();

		//we know the type and size, so that's enough to send the command.
		send_cake_order_command(type, 0, size);
	}

	else{
		printf("That's not a valid cake!\n");
		fflush(stdout);
	}

	return;
}

void send_cake_modify_command(int idx, int size){

	int id = idx;
	int siz = size;

	send_buf(main_thread_sweet_send_fd, "MODY", 4);
        send_buf(main_thread_sweet_send_fd, (char *) &id, 4);
        send_buf(main_thread_sweet_send_fd, (char *) &siz, 4);
        send_buf(main_thread_sweet_send_fd, (char *) sweet_image_buffer, size);

}

//async command
void process_cake_modify(){

	printf("Which cake do you want to modify?\n");
	fflush(stdout);
	int idx = read_int();
	printf("What is the volume of the new ingredients?\n");
	fflush(stdout);
	int size = read_int();

	//note: the 0x2000 can of course be too large for the given selfie;
	//this is hndled by the threadfn not here
	if (size < 0 || size > 0x2000){
		printf("Sorry, I can't handle that!\n");
		fflush(stdout);
		return;
	}
	else{
		memset(sweet_image_buffer, 0, 0x2000);
		read_buf(sweet_image_buffer, size);
		send_cake_modify_command(idx, size);
	}


	return;
}

//sync command
void process_cake_bake(){

	printf("Which cake would you like to bake?\n");
	fflush(stdout);

	int idx = read_int();
	if (idx < 0 || idx > 31){
		printf("Sorry, I can't handle that!\n");
		fflush(stdout);
		return;
	}

	send_buf(main_thread_sweet_send_fd, "BAKE", 4);

	send_buf(main_thread_sweet_send_fd, (char *) &idx, 4);

	printf("Waiting for the cake to be baked...\n");
	fflush(stdout);

	int is_def = -1;
	recv_buf(main_thread_sweet_recv_fd, (char *) &is_def, 4);

	if (is_def == -1){
		printf("Sorry, it looks like our bakers can't find the cake!\n");
		fflush(stdout);
		return;
	}

	if (is_def == 1){
		printf("Oh here you go, straight from the owen!\n");
		fflush(stdout);
		puts(sweet_ascii);
		fflush(stdout);
		return;
	}

	int size = -1;

	recv_buf(main_thread_sweet_recv_fd, (char *) &size, 4);

	if (size < 0 || size > 0x2000){
		printf("Sorry, it looks like our bakers dropped the cake! :S Oops!\n");
		fflush(stdout);
		return;
	}

	int type = -1;
	recv_buf(main_thread_sweet_recv_fd, (char *) &type, 4);

	memset(sweet_image_buffer, 0, 0x2000);

	if (type == 1){
		recv_string(main_thread_sweet_recv_fd, (char *) sweet_image_buffer, size);
		puts(sweet_image_buffer);
	}
	else{
		recv_buf(main_thread_sweet_recv_fd, (char *) sweet_image_buffer, size);
		write(1, sweet_image_buffer, size);
	}

	return;
}

//async command? probably must be sync
void process_cake_trash(){

	printf("Which cake would you like to throw out? (Idx)\n");
	fflush(stdout);

	int idx = read_int();

	send_buf(main_thread_sweet_send_fd, "TRSH", 4);
	send_buf(main_thread_sweet_send_fd, (char *) &idx, 4);

	return;

}

void process_sweets_command(){

	int choice = read_int();
	switch(choice){

		//order, modify, bake, trash

		case 1:
			process_cake_order();
			break;
		case 2:
			process_cake_modify();
			break;
		case 3:
			process_cake_bake();
			break;
		case 4:
			process_cake_trash();
			break;
		default:
			break;
	}
}

void do_sweets(){
	if (is_bakery_open == 0){
		printf("Oh no, the bakery isn't open yet! I'll call up the Cake Boss");
		fflush(stdout);
        	pthread_t new_thread;
        	int ret = pthread_create(&new_thread, NULL, sweets_threadfn, (void *) "SWEETS");
		if (ret != 0){
			printf("Holy smokes, Carlo suffered a heartattack!\n");
			fflush(stdout);
			exit(-1);
		}

		//First setup the listener where the thread responds to us

		int recvfd = socket(AF_UNIX, SOCK_STREAM, 0);
		if (recvfd < 0){
			printf("Disaster! Carlo quit his job to pursue a new career as a reality tv star!\n");
			fflush(stdout);
			exit(-1);
		}

		struct sockaddr_un saddr = {AF_UNIX, "/data/local/tmp/socket_bakery_to_shop"};	
		ret = bind(recvfd, (struct sockaddr *)&saddr, sizeof(saddr));
		if (ret < 0){
			printf("Blimey, we got diabetes from all the sugar!\n");
			fflush(stdout);
			exit(-1);
		}
		ret = listen(recvfd, 1);

		main_started_listening_to_sweet = 1;

		main_thread_sweet_recv_fd = accept(recvfd, NULL, NULL);

		//Second connect to the thread's listener where we can send requests
	
		struct sockaddr_un saddr2 = {AF_UNIX, "/data/local/tmp/socket_shop_to_bakery"};	
		main_thread_sweet_send_fd = socket(AF_UNIX, SOCK_STREAM, 0);

		while(1){
			if(sweet_started_listening_to_main == 1){
				break;
			}
			sleep(1);
		}

		connect(main_thread_sweet_send_fd, (struct sockaddr *)&saddr2, sizeof(saddr2));

		for (int i = 0; i < 3; i++){
			printf(".");
			fflush(stdout);
			sleep(1);
		}

		printf("\nAll right, the bakery is open for business!\n");
		fflush(stdout);

		is_bakery_open = 1;

		print_sweets_menu();
		process_sweets_command();
	}
	else{
		printf("Our bakers are completely tied up in a cupcake-related emergency right now.\nLet me know what you're craving and I'll pass it along!\n");
		fflush(stdout);
		print_sweets_menu();
		process_sweets_command();
	}
	return;
}

void do_selfies(){
	if (is_social_media_team_awake == 0){
		printf("Gosh darnit, our social media team is not awake yet!\nLet's wake them up");
		fflush(stdout);

        	pthread_t new_thread1;
        	int ret = pthread_create(&new_thread1, NULL, selfie_threadfn, (void *) "SELFIES");
		if (ret != 0){
			printf("Oh no, elite hackers took over our Instagram!\n");
			fflush(stdout);
			exit(-1);
		}

		//First setup the listener where the thread responds to us

		int recvfd = socket(AF_UNIX, SOCK_STREAM, 0);
		if (recvfd < 0){
			printf("What happened, our engagement plummeted we no longer matter!\n");
			fflush(stdout);
			exit(-1);
		}

		struct sockaddr_un saddr = {AF_UNIX, "/data/local/tmp/socket_social_to_shop"};	
		ret = bind(recvfd, (struct sockaddr *)&saddr, sizeof(saddr));
		if (ret < 0){
			printf("Dear me, AOC went viral and nobody pays attention to anything else anymore!\n");
			puts(strerror(errno));
			fflush(stdout);
			exit(-1);
		}
		ret = listen(recvfd, 1);

		//setting up synchronization barrier
		main_started_listening_to_selfie = 1;

		main_thread_selfie_recv_fd = accept(recvfd, NULL, NULL);

		//Second connect to the thread's listener where we can send requests
	
		struct sockaddr_un saddr2 = {AF_UNIX, "/data/local/tmp/socket_shop_to_social"};	
		main_thread_selfie_send_fd = socket(AF_UNIX, SOCK_STREAM, 0);

		//wait out sync barrier
		while(1){
			if(selfie_started_listening_to_main == 1){
				break;
			}
			sleep(1);
		}


		connect(main_thread_selfie_send_fd, (struct sockaddr *)&saddr2, sizeof(saddr2));

                for (int i = 0; i < 3; i++){
                        printf(".");
                        fflush(stdout);
                        sleep(1);
                }

		printf("\nOk our VP of influencer marketing just came online!\n");
		fflush(stdout);

		is_social_media_team_awake = 1;

		print_selfies_menu();
		process_selfies_command();
	}
	else{
		printf("Geez, our social media experts are super busy with sliding into DMs right now.\nIf you have a collaboration request, I can pass it along and they'll get on it ASAP!\n");
		fflush(stdout);

		print_selfies_menu();
		process_selfies_command();
	}
	return;
}

int main(){

	printf("%d %d %d\n", getuid(), getgid(), getpid());
	fflush(stdout);

	int choice = -1;
	print_banner();
	while(1){
		print_menu();
		choice = read_int();
		switch(choice){
			case 1:
				do_sweets();
				break;
			case 2:
				do_selfies();
				break;
			default:
				printf("Well I hope you enjoyed your time and made some magical memories!\nCome back soon!\n");
				fflush(stdout);
				exit(0);
		}
	}

}
